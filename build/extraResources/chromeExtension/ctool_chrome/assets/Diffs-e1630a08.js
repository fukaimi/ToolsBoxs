import{P as we,E as C,a as oe,S as N,i as te,F as Ve,V as Ge,aa as Ne,R as $,D,a9 as Z,ab as $e,ac as be,W as Ae,ad as Fe,p as ze}from"./index-1a29e17b.js";import{a as Ue,b as We,c as Ie}from"./index-5c79985c.js";import{A as Pe,bi as qe,by as He,aA as J,al as je,aq as Je,be as K,m as Ke,bj as V,aF as L,as as Qe,x as k,p as Ye,ae as Ze,a$ as S}from"./history-7dbe2ade.js";import{u as Xe,i as et}from"./action-282deb75.js";import{b as tt,a as nt,f as le}from"./index-1e85393e.js";import"./index-2e6f94de.js";import"./shim-03580cdb.js";import"./_commonjsHelpers-87174ba5.js";import"./index-395898e3.js";class v{constructor(e,r,i,o){this.fromA=e,this.toA=r,this.fromB=i,this.toB=o}offset(e,r){return new v(this.fromA+e,this.toA+e,this.fromB+r,this.toB+r)}}function F(t,e,r,i,o,n){if(t==i)return[];let l=ne(t,e,r,i,o,n),s=re(t,e+l,r,i,o+l,n);e+=l,r-=s,o+=l,n-=s;let u=r-e,f=n-o;if(!u||!f)return[new v(e,r,o,n)];if(u>f){let c=t.slice(e,r).indexOf(i.slice(o,n));if(c>-1)return[new v(e,e+c,o,o),new v(e+c+f,r,n,n)]}else if(f>u){let c=i.slice(o,n).indexOf(t.slice(e,r));if(c>-1)return[new v(e,e,o,o+c),new v(r,r,o+c+u,n)]}if(u==1||f==1)return[new v(e,r,o,n)];let a=ke(t,e,r,i,o,n);if(a){let[c,d,h]=a;return F(t,e,c,i,o,d).concat(F(t,c+h,r,i,d+h,n))}return rt(t,e,r,i,o,n)}function rt(t,e,r,i,o,n){let l=r-e,s=n-o,u=Math.ceil((l+s)/2);Q.reset(u),Y.reset(u);let f=(h,m)=>t.charCodeAt(e+h)==i.charCodeAt(o+m),a=(h,m)=>t.charCodeAt(r-h-1)==i.charCodeAt(n-m-1),c=(l-s)%2!=0?Y:null,d=c?null:Q;for(let h=0;h<u;h++){let m=Q.advance(h,l,s,u,c,!1,f)||Y.advance(h,l,s,u,d,!0,a);if(m)return it(t,e,r,e+m[0],i,o,n,o+m[1])}return[new v(e,r,o,n)]}class xe{constructor(){this.vec=[]}reset(e){this.len=e<<1;for(let r=0;r<this.len;r++)this.vec[r]=-1;this.vec[e+1]=0,this.start=this.end=0}advance(e,r,i,o,n,l,s){for(let u=-e+this.start;u<=e-this.end;u+=2){let f=o+u,a=u==-e||u!=e&&this.vec[f-1]<this.vec[f+1]?this.vec[f+1]:this.vec[f-1]+1,c=a-u;for(;a<r&&c<i&&s(a,c);)a++,c++;if(this.vec[f]=a,a>r)this.end+=2;else if(c>i)this.start+=2;else if(n){let d=o+(r-i)-u;if(d>=0&&d<this.len&&n.vec[d]!=-1)if(l){let h=n.vec[d];if(h>=r-a)return[h,o+h-d]}else{let h=r-n.vec[d];if(a>=h)return[a,c]}}}return null}}const Q=new xe,Y=new xe;function it(t,e,r,i,o,n,l,s){let u=!1;return!T(t,i)&&++i==r&&(u=!0),!T(o,s)&&++s==l&&(u=!0),u?[new v(e,r,n,l)]:F(t,e,i,o,n,s).concat(F(t,i,r,o,s,l))}function Ce(t,e){let r=1,i=Math.min(t,e);for(;r<i;)r=r<<1;return r}function ne(t,e,r,i,o,n){if(e==r||e==n||t.charCodeAt(e)!=i.charCodeAt(o))return 0;let l=Ce(r-e,n-o);for(let s=e,u=o;;){let f=s+l,a=u+l;if(f>r||a>n||t.slice(s,f)!=i.slice(u,a)){if(l==1)return s-e-(T(t,s)?0:1);l=l>>1}else{if(f==r||a==n)return f-e;s=f,u=a}}}function re(t,e,r,i,o,n){if(e==r||o==n||t.charCodeAt(r-1)!=i.charCodeAt(n-1))return 0;let l=Ce(r-e,n-o);for(let s=r,u=n;;){let f=s-l,a=u-l;if(f<e||a<o||t.slice(f,s)!=i.slice(a,u)){if(l==1)return r-s-(T(t,s)?0:1);l=l>>1}else{if(f==e||a==o)return r-f;s=f,u=a}}}function ke(t,e,r,i,o,n){let l=r-e,s=n-o;if(l<s){let d=ke(i,o,n,t,e,r);return d&&[d[1],d[0],d[2]]}if(l<4||s*2<l)return null;let u=i.slice(o,n);function f(d){let h=d+Math.floor(l/4);if(T(t,d)||d++,T(t,h)||h--,d>=h)return null;let m=t.slice(d,h),g=-1,p;for(;(g=u.indexOf(m,g+1))!=-1;){let x=ne(t,h,r,i,o+g+m.length,n),A=re(t,e,d,i,o,o+g),b=m.length+x+A;(!p||p[2]<b)&&(p=[d-A,o+g-A,b])}return p&&p[2]*2>l?p:null}let a=f(e+Math.ceil(l/4)),c=f(e+Math.ceil(l/2));return a&&(!c||c[2]<a[2])?a:c}function Be(t,e){for(let r=1;r<t.length;r++){let i=t[r-1],o=t[r];i.toA>o.fromA-e&&i.toB>o.fromB-e&&(t[r-1]=new v(i.fromA,o.toA,i.fromB,o.toB),t.splice(r--,1))}}function ot(t,e,r){for(;;){Be(r,1);let i=!1;for(let o=0;o<r.length;o++){let n=r[o],l,s;(l=ne(t,n.fromA,n.toA,e,n.fromB,n.toB))&&(n=r[o]=new v(n.fromA+l,n.toA,n.fromB+l,n.toB)),(s=re(t,n.fromA,n.toA,e,n.fromB,n.toB))&&(n=r[o]=new v(n.fromA,n.toA-s,n.fromB,n.toB-s));let u=n.toA-n.fromA,f=n.toB-n.fromB;if(u&&f)continue;let a=n.fromA-(o?r[o-1].toA:0),c=(o<r.length-1?r[o+1].fromA:t.length)-n.toA;if(!a||!c)continue;let d=u?t.slice(n.fromA,n.toA):e.slice(n.fromB,n.toB);a<=d.length&&t.slice(n.fromA-a,n.fromA)==d.slice(d.length-a)?(r[o]=new v(n.fromA-a,n.toA-a,n.fromB-a,n.toB-a),i=!0):c<=d.length&&t.slice(n.toA,n.toA+c)==d.slice(0,c)&&(r[o]=new v(n.fromA+c,n.toA+c,n.fromB+c,n.toB+c),i=!0)}if(!i)break}return r}function lt(t,e,r){for(let i=0,o=0;o<t.length;o++){let n=t[o],l=n.toA-n.fromA,s=n.toB-n.fromB;if(l&&s||l>3||s>3){let u=o==t.length-1?e.length:t[o+1].fromA,f=n.fromA-i,a=u-n.toA,c=ae(e,n.fromA,Math.min(f,5)),d=se(e,n.toA,Math.min(a,5)),h=n.fromA-c,m=d-n.toA;if(!l||!s){let g=Math.max(l,s),[p,x,A]=l?[e,n.fromA,n.toA]:[r,n.fromB,n.toB],b,M;h&&m?(g>h&&e.slice(c,n.fromA)==p.slice(A-h,A)?(n=t[o]=new v(c,c+l,n.fromB-h,n.toB-h),c=n.fromA,d=se(e,n.toA,Math.min(u-n.toA,5))):g>m&&e.slice(n.toA,d)==p.slice(x,x+m)&&(n=t[o]=new v(d-l,d,n.fromB+m,n.toB+m),d=n.toA,c=ae(e,n.fromA,Math.min(n.fromA-i,5))),h=n.fromA-c,m=d-n.toA):!h&&!m&&(M=n.fromA-(b=st(e,n.fromA,f)))&&e.slice(b,n.fromA)==p.slice(A-M,A)&&(n=t[o]=new v(b,b+l,n.fromB-M,n.toB-M))}(h||m)&&(n=t[o]=new v(n.fromA-h,n.toA+m,n.fromB-h,n.toB+m)),i=n.toA}}return Be(t,3),t}let y;try{y=new RegExp("[\\p{Alphabetic}\\p{Number}]","u")}catch{}function Me(t){return t>48&&t<58||t>64&&t<91||t>96&&t<123}function De(t,e){if(e==t.length)return 0;let r=t.charCodeAt(e);return r<192?Me(r)?1:0:y?!Le(r)||e==t.length-1?y.test(String.fromCharCode(r))?1:0:y.test(t.slice(e,e+2))?2:0:0}function Se(t,e){if(!e)return 0;let r=t.charCodeAt(e-1);return r<192?Me(r)?1:0:y?!ye(r)||e==1?y.test(String.fromCharCode(r))?1:0:y.test(t.slice(e-2,e))?2:0:0}function se(t,e,r){if(e==t.length||!Se(t,e))return e;for(let i=e,o=e+r;;){let n=De(t,i);if(!n)return i;if(i+=n,i>o)return e}}function ae(t,e,r){if(!e||!De(t,e))return e;for(let i=e,o=e-r;;){let n=Se(t,i);if(!n)return i;if(i-=n,i<o)return e}}function st(t,e,r){for(let i=e,o=e-r;;){let n=i?t.charCodeAt(i-1):10;if(n==10)return i;if(i--,i<o||n!=32&&n!=9)return e}}const Le=t=>t>=55296&&t<=56319,ye=t=>t>=56320&&t<=57343;function T(t,e){return!e||e==t.length||!Le(t.charCodeAt(e-1))||!ye(t.charCodeAt(e))}function at(t,e){return ot(t,e,F(t,0,t.length,e,0,e.length))}function Oe(t,e){return lt(at(t,e),t,e)}class ie{constructor(e,r,i,o,n){this.changes=e,this.fromA=r,this.toA=i,this.fromB=o,this.toB=n}offset(e,r){return e||r?new ie(this.changes,this.fromA+e,this.toA+e,this.fromB+r,this.toB+r):this}get endA(){return Math.max(this.fromA,this.toA-1)}get endB(){return Math.max(this.fromB,this.toB-1)}}function ue(t,e,r,i){let o=r.lineAt(t),n=i.lineAt(e);return o.to==t&&n.to==e?[Math.min(r.length,t+1),Math.min(i.length,e+1)]:[o.from,n.from]}function he(t,e,r,i){let o=r.lineAt(t),n=i.lineAt(e);return o.from==t&&n.from==e?[t,e]:[o.to+1,n.to+1]}function _e(t,e,r,i,o){let n=[];for(let l=0;l<t.length;l++){let s=t[l],[u,f]=ue(s.fromA+i,s.fromB+o,e,r),[a,c]=he(s.toA+i,s.toB+o,e,r),d=[s.offset(-u+i,-f+o)];for(;l<t.length-1;){let h=t[l+1],[m,g]=ue(h.fromA+i,h.fromB+o,e,r);if(m>a+1&&g>c+1)break;d.push(h.offset(-u+i,-f+o)),[a,c]=he(h.toA+i,h.toB+o,e,r),l++}n.push(new ie(d,u,Math.max(u,a),f,Math.max(f,c)))}return n}function ut(t,e){return _e(Oe(t.toString(),e.toString()),t,e,0,0)}const z=1e3;function fe(t,e,r,i){let o=0,n=t.length;for(;;){if(o==n){let a=0,c=0;o&&({toA:a,toB:c}=t[o-1]);let d=e-(r?a:c);return[a+d,c+d]}let l=o+n>>1,s=t[l],[u,f]=r?[s.fromA,s.toA]:[s.fromB,s.toB];if(u>e)n=l;else if(f<=e)o=l+1;else return i?[s.fromA,s.fromB]:[s.toA,s.toB]}}function Te(t,e,r,i){let o=[];return e.iterChangedRanges((n,l,s,u)=>{let f=0,a=r?e.length:i,c=0,d=r?i:e.length;n>z&&([f,c]=fe(t,n-z,r,!0)),l<e.length-z&&([a,d]=fe(t,l+z,r,!1));let h=u-s-(l-n),m,[g,p]=r?[h,0]:[0,h];o.length&&(m=o[o.length-1]).toA>=f?o[o.length-1]={fromA:m.fromA,fromB:m.fromB,toA:a,toB:d,diffA:m.diffA+g,diffB:m.diffB+p}:o.push({fromA:f,toA:a,fromB:c,toB:d,diffA:g,diffB:p})}),o}function Ee(t,e,r,i){if(!t.length)return e;let o=0,n=0,l=0,s=[];for(let u of t){let f=u.fromA+n,a=u.toA+n+u.diffA,c=u.fromB+l,d=u.toB+l+u.diffB;for(;o<e.length;){let h=e[o];if(h.toA+n<=f)s.push(h.offset(n,l));else if(h.fromA+n>a)break;o++}for(let h of _e(Oe(r.sliceString(f,a),i.sliceString(c,d)),r,i,f,c))s.push(h);n+=u.diffA,l+=u.diffB}for(;o<e.length;)s.push(e[o++].offset(n,l));return s}function ht(t,e,r){return Ee(Te(t,e.changes,!0,r.length),t,e.newDoc,r)}function ft(t,e,r){return Ee(Te(t,e.changes,!1,r.length),t,r,e.newDoc)}const X=N.define(),E=te.define({create(t){return null},update(t,e){for(let r of e.effects)r.is(X)&&(t=r.value);return t}}),B=Ve.define({combine:t=>t[0]}),Re=Ge.fromClass(class{constructor(t){({deco:this.deco,gutter:this.gutter}=me(t))}update(t){(t.docChanged||t.viewportChanged||ct(t.startState,t.state)||dt(t.startState,t.state))&&({deco:this.deco,gutter:this.gutter}=me(t.view))}},{decorations:t=>t.deco}),U=we.low(Ne({class:"cm-changeGutter",markers:t=>{var e;return((e=t.plugin(Re))===null||e===void 0?void 0:e.gutter)||Z.empty},renderEmptyElements:!1}));function ct(t,e){return t.field(E,!1)!=e.field(E,!1)}function dt(t,e){return t.facet(B)!=e.facet(B)}const ce=D.line({class:"cm-changedLine"}),mt=D.mark({class:"cm-changedText"}),de=new class extends Fe{constructor(){super(...arguments),this.elementClass="cm-changedLineGutter"}};function gt(t,e,r,i,o,n){let l=r?t.fromA:t.fromB,s=r?t.toA:t.toB,u=0;if(l!=s){o.add(l,l,ce),n&&n.add(l,l,de);for(let f=e.iterRange(l,s-1),a=l;!f.next().done;){if(f.lineBreak){a++,o.add(a,a,ce),n&&n.add(a,a,de);continue}let c=a+f.value.length;if(i)for(;u<t.changes.length;){let d=t.changes[u],h=l+(r?d.fromA:d.fromB),m=l+(r?d.toA:d.toB),g=Math.max(a,h),p=Math.min(c,m);if(g<p&&o.add(g,p,mt),m<c)u++;else break}a=c}}}function me(t){let e=t.state.field(E),{side:r,highlightChanges:i,markGutter:o}=t.state.facet(B),n=r=="a",l=new $,s=o?new $:null,{from:u,to:f}=t.viewport;for(let a of e){if((n?a.fromA:a.fromB)>=f)break;(n?a.toA:a.toB)>u&&gt(a,t.state.doc,n,i,l,s)}return{deco:l.finish(),gutter:s&&s.finish()}}class W extends Ae{constructor(e){super(),this.height=e}eq(e){return this.height==e.height}toDOM(){let e=document.createElement("div");return e.className="cm-mergeSpacer",e.style.height=this.height+"px",e}updateDOM(e){return e.style.height=this.height+"px",!0}get estimatedHeight(){return this.height}ignoreEvent(){return!1}}const q=N.define({map:(t,e)=>t.map(e)}),G=te.define({create:()=>D.none,update:(t,e)=>{for(let r of e.effects)if(r.is(q))return r.value;return t.map(e.changes)},provide:t=>C.decorations.from(t)}),I=1e-4;function pt(t,e,r){let i=new $,o=new $,n=t.viewportLineBlocks,l=e.viewportLineBlocks,s=0,u=0,f=t.state.field(G).iter(),a=e.state.field(G).iter(),c=0,d=0,h=0,m=0;e:for(let A=0;;A++){let b=A<r.length?r[A]:null,[M,R]=b?[b.fromA,b.fromB]:[t.state.doc.length,e.state.doc.length];if(c<M&&d<R)for(;;){if(s==n.length||u==l.length)break e;let w=n[s],O=l[u];for(;f.value&&f.from<w.from;)h-=f.value.spec.widget.height,f.next();for(;a.value&&a.from<O.from;)m-=a.value.spec.widget.height,a.next();if(w.from>=M||O.from>=R)break;let H=w.from-c,j=O.from-d;if(H<0||H<j)s++;else if(j<0||j<H)u++;else{let _=w.top+h-(O.top+m);_<-I?(h-=_,i.add(w.from,w.from,D.widget({widget:new W(-_),block:!0,side:-1}))):_>I&&(m+=_,o.add(O.from,O.from,D.widget({widget:new W(_),block:!0,side:-1}))),s++,u++}}if(!b)break;c=b.toA,d=b.toB}for(;f.value;)h-=f.value.spec.widget.height,f.next();for(;a.value;)m-=a.value.spec.widget.height,a.next();let g=t.contentHeight+h-(e.contentHeight+m);g<I?i.add(t.state.doc.length,t.state.doc.length,D.widget({widget:new W(-g),block:!0,side:1})):g>I&&o.add(e.state.doc.length,e.state.doc.length,D.widget({widget:new W(g),block:!0,side:1}));let p=i.finish(),x=o.finish();Z.eq([p],[t.state.field(G)])||t.dispatch({effects:q.of(p)}),Z.eq([x],[e.state.field(G)])||e.dispatch({effects:q.of(x)})}const ee=N.define({map:(t,e)=>e.mapPos(t)});class vt extends Ae{constructor(e){super(),this.lines=e}eq(e){return this.lines==e.lines}toDOM(e){let r=document.createElement("div");return r.className="cm-collapsedLines",r.textContent="⦚ "+e.state.phrase("$ unchanged lines",this.lines)+" ⦚",r.addEventListener("click",i=>{let o=e.posAtDOM(i.target);e.dispatch({effects:ee.of(o)});let{side:n,sibling:l}=e.state.facet(B);l().dispatch({effects:ee.of(wt(o,e.state.field(E),n=="a"))})}),r}ignoreEvent(e){return e instanceof MouseEvent}get estimatedHeight(){return 27}}function wt(t,e,r){let i=0,o=0;for(let n=0;;n++){let l=n<e.length?e[n]:null;if(!l||(r?l.fromA:l.fromB)>=t)return o+(t-i);[i,o]=r?[l.toA,l.toB]:[l.toB,l.toA]}}const bt=te.define({create(t){return D.none},update(t,e){t=t.map(e.changes);for(let r of e.effects)r.is(ee)&&(t=t.update({filter:i=>i!=r.value}));return t},provide:t=>C.decorations.from(t)});function ge({margin:t=3,minSize:e=4}){return bt.init(r=>At(r,t,e))}function At(t,e,r){let i=new $,o=t.facet(B).side=="a",n=t.field(E),l=1;for(let s=0;;s++){let u=s<n.length?n[s]:null,f=s?l+e:1,a=u?t.doc.lineAt(o?u.fromA:u.fromB).number-1-e:t.doc.lines,c=a-f+1;if(c>=r&&i.add(t.doc.line(f).from,t.doc.line(a).to,D.replace({widget:new vt(c),block:!0})),!u)break;l=t.doc.lineAt(Math.min(t.doc.length,o?u.toA:u.toB)).number}return i.finish()}const xt=C.styleModule.of(new $e({".cm-mergeView":{overflowY:"auto"},".cm-mergeViewEditors":{display:"flex",alignItems:"stretch"},".cm-mergeViewEditor":{flexGrow:1,flexBasis:0,overflow:"hidden"},".cm-merge-revert":{width:"1.6em",flexGrow:0,flexShrink:0,position:"relative"},".cm-merge-revert button":{position:"absolute",display:"block",width:"100%",boxSizing:"border-box",textAlign:"center",background:"none",border:"none",font:"inherit",cursor:"pointer"}})),Ct=C.baseTheme({"& .cm-scroller, &":{height:"auto !important",overflowY:"visible !important"},"&.cm-merge-a .cm-changedLine":{backgroundColor:"rgba(160, 128, 100, .08)"},"&.cm-merge-b .cm-changedLine":{backgroundColor:"rgba(100, 160, 128, .08)"},"&light.cm-merge-a .cm-changedText":{background:"linear-gradient(#ee443366, #ee443366) bottom/100% 2px no-repeat"},"&dark.cm-merge-a .cm-changedText":{background:"linear-gradient(#ffaa9966, #ffaa9966) bottom/100% 2px no-repeat"},"&light.cm-merge-b .cm-changedText":{background:"linear-gradient(#22bb2266, #22bb2266) bottom/100% 2px no-repeat"},"&dark.cm-merge-b .cm-changedText":{background:"linear-gradient(#88ff8866, #88ff8866) bottom/100% 2px no-repeat"},".cm-collapsedLines":{padding:"5px 5px 5px 10px",cursor:"pointer"},"&light .cm-collapsedLines":{color:"#444",background:"linear-gradient(to bottom, transparent 0, #f3f3f3 30%, #f3f3f3 70%, transparent 100%)"},"&dark .cm-collapsedLines":{color:"#ddd",background:"linear-gradient(to bottom, transparent 0, #222 30%, #222 70%, transparent 100%)"},".cm-changeGutter":{width:"3px",paddingLeft:"1px"},"&light.cm-merge-a .cm-changedLineGutter":{background:"#e43"},"&dark.cm-merge-a .cm-changedLineGutter":{background:"#fa9"},"&light.cm-merge-b .cm-changedLineGutter":{background:"#2b2"},"&dark.cm-merge-b .cm-changedLineGutter":{background:"#8f8"}}),pe=new be,P=new be;class kt{constructor(e){this.revertDOM=null,this.revertToA=!1,this.revertToLeft=!1,this.measuring=-1;let r=[we.low(Re),Ct,xt,G,C.updateListener.of(c=>{this.measuring<0&&(c.heightChanged||c.viewportChanged)&&!c.transactions.some(d=>d.effects.some(h=>h.is(q)))&&this.measure()})],i=[B.of({side:"a",sibling:()=>this.b,highlightChanges:e.highlightChanges!==!1,markGutter:e.gutter!==!1})];e.gutter!==!1&&i.push(U);let o=oe.create({doc:e.a.doc,selection:e.a.selection,extensions:[e.a.extensions||[],C.editorAttributes.of({class:"cm-merge-a"}),P.of(i),r]}),n=[B.of({side:"b",sibling:()=>this.a,highlightChanges:e.highlightChanges!==!1,markGutter:e.gutter!==!1})];e.gutter!==!1&&n.push(U);let l=oe.create({doc:e.b.doc,selection:e.b.selection,extensions:[e.b.extensions||[],C.editorAttributes.of({class:"cm-merge-b"}),P.of(n),r]});this.chunks=ut(o.doc,l.doc);let s=[E.init(()=>this.chunks),pe.of(e.collapseUnchanged?ge(e.collapseUnchanged):[])];o=o.update({effects:N.appendConfig.of(s)}).state,l=l.update({effects:N.appendConfig.of(s)}).state,this.dom=document.createElement("div"),this.dom.className="cm-mergeView",this.editorDOM=this.dom.appendChild(document.createElement("div")),this.editorDOM.className="cm-mergeViewEditors";let u=e.orientation||"a-b",f=document.createElement("div");f.className="cm-mergeViewEditor";let a=document.createElement("div");a.className="cm-mergeViewEditor",this.editorDOM.appendChild(u=="a-b"?f:a),this.editorDOM.appendChild(u=="a-b"?a:f),this.a=new C({state:o,parent:f,root:e.root,dispatch:c=>this.dispatch(c,this.a)}),this.b=new C({state:l,parent:a,root:e.root,dispatch:c=>this.dispatch(c,this.b)}),this.setupRevertControls(!!e.revertControls,e.revertControls=="b-to-a",e.renderRevertControl),e.parent&&e.parent.appendChild(this.dom),this.scheduleMeasure()}dispatch(e,r){if(e.docChanged){this.chunks=r==this.a?ht(this.chunks,e,this.b.state.doc):ft(this.chunks,e,this.a.state.doc),r.update([e,e.state.update({effects:X.of(this.chunks)})]);let i=r==this.a?this.b:this.a;i.update([i.state.update({effects:X.of(this.chunks)})]),this.scheduleMeasure()}else r.update([e])}reconfigure(e){if("orientation"in e){let n=e.orientation!="b-a";if(n!=(this.editorDOM.firstChild==this.a.dom.parentNode)){let l=this.a.dom.parentNode,s=this.b.dom.parentNode;l.remove(),s.remove(),this.editorDOM.insertBefore(n?l:s,this.editorDOM.firstChild),this.editorDOM.appendChild(n?s:l),this.revertToLeft=!this.revertToLeft,this.revertDOM&&(this.revertDOM.textContent="")}}if("revertControls"in e||"renderRevertControl"in e){let n=!!this.revertDOM,l=this.revertToA,s=this.renderRevert;"revertControls"in e&&(n=!!e.revertControls,l=e.revertControls=="b-to-a"),"renderRevertControl"in e&&(s=e.renderRevertControl),this.setupRevertControls(n,l,s)}let r="highlightChanges"in e,i="gutter"in e,o="collapseUnchanged"in e;if(r||i||o){let n=[],l=[];if(r||i){let s=this.a.state.facet(B),u=i?e.gutter!==!1:s.markGutter,f=r?e.highlightChanges!==!1:s.highlightChanges;n.push(P.reconfigure([B.of({side:"a",sibling:()=>this.b,highlightChanges:f,markGutter:u}),u?U:[]])),l.push(P.reconfigure([B.of({side:"b",sibling:()=>this.a,highlightChanges:f,markGutter:u}),u?U:[]]))}if(o){let s=pe.reconfigure(e.collapseUnchanged?ge(e.collapseUnchanged):[]);n.push(s),l.push(s)}this.a.dispatch({effects:n}),this.b.dispatch({effects:l})}this.scheduleMeasure()}setupRevertControls(e,r,i){this.revertToA=r,this.revertToLeft=this.revertToA==(this.editorDOM.firstChild==this.a.dom.parentNode),this.renderRevert=i,!e&&this.revertDOM?(this.revertDOM.remove(),this.revertDOM=null):e&&!this.revertDOM?(this.revertDOM=this.editorDOM.insertBefore(document.createElement("div"),this.editorDOM.firstChild.nextSibling),this.revertDOM.addEventListener("mousedown",o=>this.revertClicked(o)),this.revertDOM.className="cm-merge-revert"):this.revertDOM&&(this.revertDOM.textContent="")}scheduleMeasure(){if(this.measuring<0){let e=this.dom.ownerDocument.defaultView||window;this.measuring=e.requestAnimationFrame(()=>{this.measuring=-1,this.measure()})}}measure(){pt(this.a,this.b,this.chunks),this.revertDOM&&this.updateRevertButtons()}updateRevertButtons(){let e=this.revertDOM,r=e.firstChild,i=this.a.viewport,o=this.b.viewport;for(let n=0;n<this.chunks.length;n++){let l=this.chunks[n];if(l.fromA>i.to||l.fromB>o.to)break;if(l.fromA<i.from||l.fromB<o.from)continue;let s=this.a.lineBlockAt(l.fromA).top+"px";for(;r&&+r.dataset.chunk<n;)r=ve(r);r&&r.dataset.chunk==String(n)?(r.style.top!=s&&(r.style.top=s),r=r.nextSibling):e.insertBefore(this.renderRevertButton(s,n),r)}for(;r;)r=ve(r)}renderRevertButton(e,r){let i;if(this.renderRevert)i=this.renderRevert();else{i=document.createElement("button");let o=this.a.state.phrase("Revert this chunk");i.setAttribute("aria-label",o),i.setAttribute("title",o),i.textContent=this.revertToLeft?"⇜":"⇝"}return i.style.top=e,i.setAttribute("data-chunk",String(r)),i}revertClicked(e){let r=e.target,i;for(;r&&r.parentNode!=this.revertDOM;)r=r.parentNode;if(r&&(i=this.chunks[r.dataset.chunk])){let[o,n,l,s,u,f]=this.revertToA?[this.b,this.a,i.fromB,i.toB,i.fromA,i.toA]:[this.a,this.b,i.fromA,i.toA,i.fromB,i.toB],a=o.state.sliceDoc(l,Math.max(l,s-1));l!=s&&(a+=o.state.lineBreak),n.dispatch({changes:{from:u,to:Math.min(n.state.doc.length,f),insert:a},userEvent:"revert"}),e.preventDefault()}}destroy(){this.a.destroy(),this.b.destroy(),this.measuring>-1&&(this.dom.ownerDocument.defaultView||window).cancelAnimationFrame(this.measuring),this.dom.remove()}}function ve(t){let e=t.nextSibling;return t.remove(),e}const Et=Pe({__name:"Diffs",async setup(t){let e,r;const i=Xe(([e,r]=qe(()=>et({a:"",b:"",option:{lineWrapping:!0,lang:"Text",collapse:!1,revert:"b-to-a"}},{paste:!1})),e=await e,r(),e)),o=He();let n=J(null),l=J(null);const s=J({index:0,chunks:[]}),u=async h=>{const m=nt(h);return m?await m.load():[]},f=async()=>[o.theme.raw==="dark"?Ue:We,C.updateListener.of(h=>{l.value&&h.docChanged&&(h.view.dom.contains(l.value.a.dom)&&h.state.doc.toString()!==i.current.a&&(i.current.a=h.state.doc.toString()),h.view.dom.contains(l.value.b.dom)&&h.state.doc.toString()!==i.current.b&&(i.current.b=h.state.doc.toString()))}),await u(i.current.option.lang),i.current.option.lineWrapping?C.lineWrapping:[],ze($t("main_ui_input")),Ie()],a=async h=>{l.value&&l.value.destroy(),l.value=new kt({a:{doc:i.current.a,extensions:await f()},b:{doc:i.current.b,extensions:await f()},parent:h,revertControls:i.current.option.revert,collapseUnchanged:i.current.option.collapse?{}:void 0,highlightChanges:!0,gutter:!0})},c=async()=>{i.current.a=await le.simple(i.current.option.lang,"beautify",i.current.a),i.current.b=await le.simple(i.current.option.lang,"beautify",i.current.b),a(n.value)},d=h=>{if(!l.value)return;const m=h==="next"?s.value.index+1:s.value.index-1,g=s.value.chunks[m];g&&(l.value.dom.scrollTo({top:l.value.a.lineBlockAt(g.fromA).top,behavior:"smooth"}),s.value.index=m)};return je(()=>{setTimeout(()=>{a(n.value)},200)}),Je(()=>{var h;(h=l.value)==null||h.destroy()}),K(()=>({color:o.theme.raw,option:i.current.option}),()=>a(n.value),{deep:!0}),K(()=>({a:i.current.a,b:i.current.b}),()=>{setTimeout(()=>{l.value&&(s.value.index=0,s.value.chunks=l.value.chunks.map(h=>({fromA:h.fromA}))||[])},1e3)},{immediate:!0}),K(()=>i.current,()=>{i.current.a===""||i.current.b===""||i.save()},{deep:!0}),(h,m)=>{const g=L("HeightResize"),p=L("Select"),x=L("Button"),A=L("Bool"),b=L("Dropdown"),M=L("Input"),R=L("Align");return Qe(),Ke(R,{direction:"vertical",class:"ctool-diff"},{default:V(()=>[k(g,{ignore:"",append:[".ctool-page-option"],reduce:5},{default:V(({height:w})=>[Ye("div",{ref_key:"container",ref:n,style:Ze({height:`${w}px`,width:"100%",overflow:"hidden"})},null,4)]),_:1},8,["append"]),k(R,{class:"ctool-page-option",horizontal:"center"},{default:V(()=>[k(p,{modelValue:S(i).current.option.lang,"onUpdate:modelValue":m[0]||(m[0]=w=>S(i).current.option.lang=w),options:S(tt)},null,8,["modelValue","options"]),k(x,{text:h.$t("code_beautify"),onClick:c},null,8,["text"]),k(A,{modelValue:S(i).current.option.lineWrapping,"onUpdate:modelValue":m[1]||(m[1]=w=>S(i).current.option.lineWrapping=w),label:h.$t("component_editor_line_wrapping"),border:""},null,8,["modelValue","label"]),k(A,{modelValue:S(i).current.option.collapse,"onUpdate:modelValue":m[2]||(m[2]=w=>S(i).current.option.collapse=w),label:h.$t("diffs_collapse"),border:""},null,8,["modelValue","label"]),k(b,{onSelect:m[3]||(m[3]=w=>S(i).current.option.revert=w),placeholder:h.$t("diffs_revert_direction"),options:[{value:"b-to-a",label:h.$t("diffs_right_to_left")},{value:"a-to-b",label:h.$t("diffs_left_to_right")}]},null,8,["placeholder","options"]),k(M,{center:"",disabled:s.value.chunks.length===0,"model-value":`${s.value.chunks.length?s.value.index+1:0} / ${s.value.chunks.length}`,width:130},{prepend:V(()=>[k(x,{disabled:s.value.chunks.length===0||s.value.index===0,text:"<",onClick:m[4]||(m[4]=w=>d("last"))},null,8,["disabled"])]),append:V(()=>[k(x,{disabled:s.value.chunks.length===0||s.value.index===s.value.chunks.length-1,text:">",onClick:m[5]||(m[5]=w=>d("next"))},null,8,["disabled"])]),_:1},8,["disabled","model-value"])]),_:1})]),_:1})}}});export{Et as default};
