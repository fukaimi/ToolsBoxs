import{u as j,i as q}from"./action-282deb75.js";import{A as G,bi as J,aA as S,m as _,bj as a,aF as u,aG as O,as as c,bl as H,o as k,x as s,p as m,ac as I,a$ as d,aD as K,F as f,w as V,aT as v,c7 as M,ab as P}from"./history-7dbe2ade.js";import{_ as Q}from"./_plugin-vue_export-helper-c27b6911.js";import"./shim-03580cdb.js";import"./_commonjsHelpers-87174ba5.js";const X={class:"ctool-page-option"},Y={class:"ctool-websocket-logs-item"},Z={class:"ctool-websocket-logs-top"},ee={class:"ctool-websocket-logs-time"},te={class:"ctool-websocket-logs-content"},oe=G({__name:"Websocket",async setup(le){let w,C;const l=j(([w,C]=J(()=>q({input:"wss://echo.websocket.events",keepScroll:!0,protocols:""},{paste:e=>/^ws/.test(e)})),w=await w,C(),w));let b=S(!1),g=0,y=!1,x;const o=S({status:"close",ws:null,send_content:"",logs:[]}),r=async(e,t="other")=>{if(o.value.logs.push({content:e,type:t,time:M().format("HH:mm:ss")}),await P(),l.current.keepScroll){const p=document.querySelector(".ctool-websocket-logs .ctool-card-body");p&&(p.scrollTop=p.scrollHeight)}},z=()=>{if(!(!l.current.input.trim()||o.value.status!=="close")){o.value.status="connecting",l.save(),r($t("websocket_connect_start",[l.current.input]));try{let e=new WebSocket(l.current.input,l.current.protocols!==""?l.current.protocols.split(","):void 0);console.log(e),e.addEventListener("open",t=>{console.log(t),o.value.status="open",E(),r($t("websocket_connect_ok"))}),e.addEventListener("close",t=>{if(console.log(t),o.value.status="close",r($t("websocket_close_ok")),b.value){if(y)return;y=!0,x=setInterval(()=>{o.value.status==="close"&&(g=g+1,r(`${$t("websocket_reconnect")} ${g}`),z())},3e3)}}),e.addEventListener("message",t=>{console.log(t),r(t.data,"accept")}),e.addEventListener("error",t=>{console.log(t),r("Websocket Error")}),o.value.ws=e}catch(e){console.log(e),r($error(e))}}},A=()=>{var e;b.value=!1,E(),r($t("websocket_close_start",[l.current.input])),(e=o.value.ws)==null||e.close()},E=()=>{g=0,y=!1,clearInterval(x)},L=()=>{var e;if(o.value.status!=="open")throw new Error($t("websocket_error_connect"));if(o.value.send_content==="")throw new Error($t("websocket_error_content"));try{(e=o.value.ws)==null||e.send(o.value.send_content),r(o.value.send_content,"send")}catch(t){r($error(t))}};return(e,t)=>{const p=u("Align"),T=u("Bool"),h=u("Input"),U=u("HelpTip"),$=u("Button"),W=u("Textarea"),D=u("Exception"),F=u("Icon"),N=u("Card"),R=u("HeightResize"),B=O("row");return c(),_(p,{direction:"vertical"},{default:a(()=>[H((c(),k("div",X,[s(h,{modelValue:d(l).current.input,"onUpdate:modelValue":t[1]||(t[1]=i=>d(l).current.input=i)},{prepend:a(()=>[s(p,{horizontal:"center",vertical:"center",width:20},{default:a(()=>[m("div",{class:I(["ctool-websocket-status",[`ctool-websocket-status-${o.value.status}`]])},null,2)]),_:1})]),suffix:a(()=>[s(T,{size:"small",modelValue:b.value,"onUpdate:modelValue":t[0]||(t[0]=i=>b.value=i),label:e.$t("websocket_reconnect")},null,8,["modelValue","label"])]),_:1},8,["modelValue"]),s(h,{modelValue:d(l).current.protocols,"onUpdate:modelValue":t[2]||(t[2]=i=>d(l).current.protocols=i),label:e.$t("websocket_protocols")},{suffix:a(()=>[s(U,{text:e.$t("websocket_protocols_tip")},null,8,["text"])]),_:1},8,["modelValue","label"]),o.value.status==="close"?(c(),_($,{key:0,onClick:t[3]||(t[3]=i=>z()),text:e.$t("websocket_connect")},null,8,["text"])):(c(),_($,{key:1,onClick:t[4]||(t[4]=i=>A()),text:e.$t("websocket_close")},null,8,["text"]))])),[[B,"16-8-auto"]]),H((c(),_(R,{ignore:"",reduce:5,append:[".ctool-page-option"]},{default:a(({height:i})=>[s(W,{height:i,modelValue:o.value.send_content,"onUpdate:modelValue":t[5]||(t[5]=n=>o.value.send_content=n),"float-text":e.$t("websocket_send"),"float-position":"top-right",onClickFloatText:L,placeholder:`${e.$t("main_ui_input")}${e.$t("websocket_send_content")}`},null,8,["height","modelValue","float-text","placeholder"]),s(N,{title:e.$t("websocket_log_content"),height:i,class:"ctool-websocket-logs"},{extra:a(()=>[s(p,null,{default:a(()=>[s($,{size:"small",type:"primary",text:e.$t("main_ui_copy"),onClick:t[6]||(t[6]=()=>e.$copy(JSON.stringify(o.value.logs)))},null,8,["text"]),s($,{size:"small",type:"danger",text:e.$t("main_ui_clear"),onClick:t[7]||(t[7]=n=>o.value.logs=[])},null,8,["text"]),s(T,{size:"small",modelValue:d(l).current.keepScroll,"onUpdate:modelValue":t[8]||(t[8]=n=>d(l).current.keepScroll=n),border:"",label:e.$t("websocket_keep_scroll"),onChange:t[9]||(t[9]=n=>d(l).save())},null,8,["modelValue","label"])]),_:1})]),default:a(()=>[o.value.logs.length<1?(c(),_(p,{key:0,horizontal:"center",vertical:"center"},{default:a(()=>[s(D)]),_:1})):(c(),_(p,{key:1,direction:"vertical"},{default:a(()=>[(c(!0),k(f,null,K(o.value.logs,n=>(c(),k("div",Y,[m("div",Z,[m("div",{class:I(["ctool-websocket-logs-type",`ctool-websocket-logs-type-${n.type}`])},[n.type==="send"?(c(),k(f,{key:0},[V(v(e.$t("websocket_client"))+"：",1)],64)):n.type==="accept"?(c(),k(f,{key:1},[V(v(e.$t("websocket_server"))+"：",1)],64)):(c(),k(f,{key:2},[V(v(e.$t("websocket_tips"))+"：",1)],64))],2),m("div",ee,v(n.time),1),s(F,{size:12,name:"copy",tooltip:e.$t("main_ui_copy"),hover:"",onClick:se=>e.$copy(n.content)},null,8,["tooltip","onClick"])]),m("pre",te,[m("code",null,v(n.content),1)])]))),256))]),_:1}))]),_:2},1032,["title","height"])]),_:1},8,["append"])),[[B,"40-60"]])]),_:1})}}});const ue=Q(oe,[["__scopeId","data-v-5ecc0581"]]);export{ue as default};
